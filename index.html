<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Gemini Reader</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Puter.js for Unlimited TTS -->
    <script src="https://js.puter.com/v2/"></script>

    <style>
        :root {
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }

        /* Glassmorphism Architecture */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Floating Player Specifics - Semi Transparent */
        .floating-player {
            background: rgba(0, 0, 0, 0.3); /* More transparent */
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border-radius: 24px;
            margin-bottom: var(--safe-bottom);
            /* Gradient blur effect */
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,1) 100%);
            mask-image: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,1) 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .glass-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .glass-card.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        /* View Transitions */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            height: 100%;
            flex-direction: column;
        }
        .view-section.active {
            display: flex;
            opacity: 1;
        }

        /* Reader Mode Styles */
        #reader-display {
            line-height: 1.8;
            font-size: 1.125rem;
            color: rgba(255, 255, 255, 0.7);
            padding-bottom: 160px; /* Space for floating player */
        }
        
        #reader-display h1 { font-size: 1.8em; font-weight: 700; color: white; margin-top: 1.5em; margin-bottom: 0.5em; }
        #reader-display h2 { font-size: 1.5em; font-weight: 600; color: white; margin-top: 1.2em; margin-bottom: 0.5em; }
        #reader-display p { margin-bottom: 1.2em; }
        
        .chunk {
            transition: background-color 0.2s ease, color 0.2s ease;
            border-radius: 4px;
            cursor: pointer;
            padding: 4px 2px;
        }
        
        .chunk:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .chunk.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        /* White Range Sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            padding: 10px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        /* Visualizer Bars (White) */
        .v-bar {
            width: 4px;
            background: #ffffff;
            border-radius: 2px;
            transition: height 0.1s ease;
            min-height: 4px;
        }

        #toaster {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translateY(-150%);
            top: 10px;
        }
        #toaster.show { transform: translateY(20px); }

        #sidebar {
            transition: transform 0.3s ease-in-out;
            padding-bottom: var(--safe-bottom);
        }
        
        .loader {
            border: 2px solid rgba(255,255,255,0.2);
            border-left-color: #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Engine Badges */
        .engine-badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        /* Gemini Blue */
        .badge-gemini { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }
        /* Puter Green */
        .badge-puter { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.5); }
        /* System White/Gray */
        .badge-system { background: rgba(255, 255, 255, 0.1); color: #9ca3af; border: 1px solid rgba(255, 255, 255, 0.2); }

        /* Install Button Pulse */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        #btn-install.visible {
            display: flex;
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>
<body class="h-screen flex flex-col relative overflow-hidden">

    <!-- Toaster -->
    <div id="toaster" class="fixed left-0 right-0 z-[60] flex justify-center pointer-events-none">
        <div id="toaster-msg" class="glass px-6 py-3 rounded-full text-sm font-medium shadow-2xl flex items-center gap-2 bg-black/90 backdrop-blur-md border-white/20"></div>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-30 h-16 px-4 flex items-center justify-between border-b border-white/10 shrink-0">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <i data-lucide="waves" class="text-white w-6 h-6"></i>
                <span class="font-semibold tracking-wide hidden md:block text-white">Gemini<span class="text-gray-400">Reader</span></span>
            </div>
            
            <nav class="flex bg-white/10 rounded-lg p-1 gap-1">
                <button onclick="switchView('reader')" id="nav-reader" class="px-3 py-1.5 rounded text-xs font-medium bg-white text-black transition-all active:scale-95 shadow-sm">Reader</button>
                <button onclick="switchView('voices')" id="nav-voices" class="px-3 py-1.5 rounded text-xs font-medium text-white/70 hover:text-white transition-all active:scale-95">Voices</button>
            </nav>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="relative group hidden md:block">
                <input type="password" id="api-key-input" placeholder="Enter Gemini API Key" 
                    class="bg-black/50 border border-white/20 rounded-lg px-3 py-1.5 text-xs w-48 focus:outline-none focus:border-white text-white transition-all">
            </div>
            <button id="menu-toggle" class="md:hidden p-2 rounded active:bg-white/10">
                <i data-lucide="menu" class="w-6 h-6 text-white"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- View Container -->
        <div class="flex-1 flex flex-col relative h-full overflow-hidden">
            
            <!-- VIEW 1: READER -->
            <div id="view-reader" class="view-section active flex-1 overflow-hidden relative">
                <!-- Scraper Bar -->
                <div class="p-4 flex gap-2 border-b border-white/5 shrink-0">
                    <div class="flex-1 relative">
                        <i data-lucide="link" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                        <input type="text" id="url-input" placeholder="Paste article URL..." 
                            class="w-full bg-white/5 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-sm text-white focus:outline-none focus:border-white/50 placeholder-white/30">
                    </div>
                    <button id="scrape-btn" class="glass px-4 rounded-lg hover:bg-white/10 transition-colors flex items-center justify-center min-w-[40px] active:bg-white/20" title="Import Article">
                        <i data-lucide="download-cloud" class="w-4 h-4 text-white"></i>
                    </button>
                    <button id="edit-toggle-btn" class="glass px-4 rounded-lg hover:bg-white/10 transition-colors flex items-center justify-center min-w-[40px] hidden active:bg-white/20" title="Edit Text">
                        <i data-lucide="edit-2" class="w-4 h-4 text-white"></i>
                    </button>
                </div>

                <!-- Text Editor -->
                <textarea id="main-text" 
                    class="flex-1 w-full bg-transparent p-6 resize-none focus:outline-none text-lg leading-relaxed text-body font-light placeholder-white/10"
                    placeholder="Paste text here or import from URL..."></textarea>
                
                <!-- Reader Display -->
                <div id="reader-display" class="hidden flex-1 w-full bg-transparent p-6 overflow-y-auto text-body font-light pb-40">
                    <!-- Content -->
                </div>
            </div>

            <!-- VIEW 2: VOICE LAB -->
            <div id="view-voices" class="view-section p-6 overflow-y-auto pb-40">
                <div class="max-w-4xl mx-auto w-full">
                    
                    <!-- Account Section -->
                    <div class="glass p-4 rounded-xl border border-white/10 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-semibold text-white flex items-center gap-2">
                                <i data-lucide="user" class="w-4 h-4"></i> Puter Account
                            </h3>
                            <!-- New Environment Status Indicator -->
                            <div class="flex flex-col items-end">
                                <span id="puter-status" class="text-[10px] uppercase font-bold tracking-wider text-white/50">Checking...</span>
                                <span id="env-status" class="text-[9px] text-white/30 mt-0.5">Detecting Env...</span>
                            </div>
                        </div>
                        <p class="text-xs text-white/60 mb-3">Login to remove guest limits.</p>
                        <div id="auth-controls">
                            <button id="btn-puter-login" class="w-full bg-white text-black py-3 rounded-lg text-sm font-bold transition flex items-center justify-center gap-2 active:scale-98 hover:bg-gray-200">
                                Connect Puter Account
                            </button>
                        </div>
                    </div>

                    <h2 class="text-xl font-semibold mb-4 text-white">Voice Intelligence</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="voice-grid">
                        <!-- Cards -->
                    </div>

                    <div id="system-voice-controls" class="mt-8 p-4 glass rounded-xl border border-white/10">
                        <h3 class="text-sm font-semibold text-white mb-2 flex items-center gap-2">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                            Offline System Voice
                        </h3>
                        <p class="text-xs text-white/50 mb-4">Fallback voice if API limits are hit.</p>
                        <select id="system-voice-select" class="w-full bg-white/5 border border-white/10 p-3 rounded-lg text-sm text-white focus:outline-none focus:border-white"></select>
                    </div>
                </div>
            </div>
            
            <!-- FLOATING PLAYER (Semi-Transparent Pill) -->
            <div class="fixed bottom-4 left-4 right-4 z-20 controls-overlay">
                <div class="floating-player p-4 max-w-2xl mx-auto">
                    <div class="flex justify-between items-center h-6 mb-3">
                        <div id="visualizer" class="flex items-end gap-1 h-full w-24 opacity-80"></div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 justify-end">
                                <span id="engine-badge" class="engine-badge badge-puter">PUTER AI</span>
                                <div id="status-text" class="text-[10px] font-mono text-white/70 tracking-widest">READY</div>
                            </div>
                            <div id="chunk-info" class="text-xs text-white font-medium">0 / 0</div>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <button id="prev-btn" class="p-2 text-white/70 hover:text-white transition active:scale-95"><i data-lucide="skip-back" class="w-6 h-6"></i></button>
                            
                            <!-- Main Play Button -->
                            <button id="play-btn" class="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition shadow-lg shadow-white/20">
                                <i data-lucide="play" class="w-6 h-6 fill-current ml-1" id="play-icon"></i>
                                <div id="play-loader" class="loader border-gray-800 border-l-transparent hidden w-6 h-6"></div>
                            </button>
                            
                            <button id="next-btn" class="p-2 text-white/70 hover:text-white transition active:scale-95"><i data-lucide="skip-forward" class="w-6 h-6"></i></button>
                        </div>
                        
                        <div class="flex-1 mx-2 relative h-2 bg-white/10 rounded-full overflow-hidden cursor-pointer group">
                            <div id="progress-bar" class="absolute top-0 left-0 h-full bg-white w-0 transition-all duration-300"></div>
                        </div>
                        
                         <div class="flex items-center gap-2 min-w-[60px] justify-end">
                            <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
                            <span id="mini-speed-val" class="text-sm font-mono font-bold">1.0x</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <aside id="sidebar" class="glass w-80 fixed md:static inset-y-0 right-0 transform translate-x-full md:translate-x-0 z-50 border-l border-white/10 flex flex-col bg-black/90 md:bg-transparent backdrop-blur-xl md:backdrop-filter-none h-full shadow-2xl">
            <div class="p-4 border-b border-white/10 flex justify-between items-center mt-safe">
                <h2 class="text-sm font-semibold uppercase tracking-wider text-white/50">Control Center</h2>
                <button id="close-sidebar" class="md:hidden text-white p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <!-- Install Button Area -->
            <div id="install-area" class="p-4 hidden border-b border-white/10 bg-white/5">
                <button id="btn-install" class="w-full bg-white text-black py-3 rounded-lg text-sm font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> Install App
                </button>
            </div>

            <div class="p-6 space-y-8 overflow-y-auto flex-1 pb-40">
                <div class="space-y-4">
                    <div class="flex justify-between items-baseline">
                        <span class="text-xs font-semibold uppercase text-white/50">Playback Speed</span>
                        <span id="speed-val" class="text-xl font-light text-white">1.0x</span>
                    </div>
                    <input type="range" id="speed-slider" min="0.5" max="4.0" step="0.1" value="1.0">
                    
                    <div class="mt-4 pt-4 border-t border-white/5">
                        <div class="flex justify-between text-xs text-white/50 mb-2">
                            <span>Base Pitch Shift</span>
                            <span id="pitch-val">0</span>
                        </div>
                        <input type="range" id="pitch-slider" min="-600" max="600" step="50" value="0">
                    </div>
                </div>
                
                <div class="h-px bg-white/10 w-full"></div>
                
                <div class="space-y-3">
                    <h3 class="text-xs font-semibold uppercase text-white/50 mb-2">AI Assistant</h3>
                    <button id="btn-summarize" class="w-full glass py-3 rounded-lg text-sm hover:bg-white/10 text-left px-4 flex items-center gap-3 transition active:scale-98 text-white">
                        <i data-lucide="file-text" class="w-4 h-4 text-white/70"></i> Summarize
                    </button>
                    <button id="btn-simplify" class="w-full glass py-3 rounded-lg text-sm hover:bg-white/10 text-left px-4 flex items-center gap-3 transition active:scale-98 text-white">
                        <i data-lucide="baby" class="w-4 h-4 text-white/70"></i> Simplify Text
                    </button>
                    <button id="btn-quiz" class="w-full glass py-3 rounded-lg text-sm hover:bg-white/10 text-left px-4 flex items-center gap-3 transition active:scale-98 text-white">
                        <i data-lucide="graduation-cap" class="w-4 h-4 text-white/70"></i> Generate Quiz
                    </button>
                </div>
                
                <div class="md:hidden pt-4 border-t border-white/10">
                    <input type="password" id="mobile-api-key" placeholder="Gemini API Key" class="w-full bg-white/5 border border-white/10 rounded px-3 py-3 text-xs text-white focus:border-white outline-none">
                </div>
            </div>
        </aside>
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/80 z-40 hidden md:hidden glass border-0"></div>
    </main>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="glass w-full max-w-lg rounded-2xl overflow-hidden flex flex-col max-h-[80vh] border-white/20">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="font-semibold text-white">Interactive Quiz</h3>
                <button id="close-quiz" class="p-1 hover:bg-white/10 rounded"><i data-lucide="x" class="w-5 h-5 text-white"></i></button>
            </div>
            <div id="quiz-content" class="p-6 overflow-y-auto space-y-6"></div>
        </div>
    </div>

    <!-- PWA Manifest & Scripts -->
    <script>
        const manifest = {
            "name": "Gemini Reader",
            "short_name": "Reader",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#000000",
            "theme_color": "#000000",
            "orientation": "portrait",
            "icons": [
                { "src": "https://cdn.lucide.dev/icon-192.png", "sizes": "192x192", "type": "image/png" },
                { "src": "https://cdn.lucide.dev/icon-512.png", "sizes": "512x512", "type": "image/png" }
            ]
        };
        const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'}));
        const link = document.createElement('link'); link.rel = 'manifest'; link.href = manifestURL; document.head.appendChild(link);

        if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
            const swContent = `self.addEventListener('install', e => self.skipWaiting()); self.addEventListener('activate', e => e.waitUntil(self.clients.claim())); self.addEventListener('fetch', e => {});`;
            navigator.serviceWorker.register(URL.createObjectURL(new Blob([swContent], {type: 'application/javascript'})));
        }
    </script>

    <script>
        const VOICES = [
            { name: "Joey", label: "Joey (Male)", desc: "Deep American voice.", tone: "Deep", provider: "puter" },
            { name: "Matthew", label: "Matthew (Male)", desc: "Very Deep, authoritative.", tone: "Deep", provider: "puter" },
            { name: "Joanna", label: "Joanna (Female)", desc: "Standard US Female.", tone: "Neutral", provider: "puter" },
            { name: "Salli", label: "Salli (Female)", desc: "Bright, energetic.", tone: "Light", provider: "puter" },
            { name: "Kore", label: "Kore (Female)", desc: "High quality (Gemini)", tone: "Neutral", provider: "gemini" },
            { name: "Fenrir", label: "Fenrir (Male)", desc: "Deep (Gemini)", tone: "Deep", provider: "gemini" }
        ];

        const state = {
            apiKey: localStorage.getItem("gemini_key") || "",
            isPlaying: false,
            textChunks: [],
            currentChunkIndex: 0,
            playbackId: 0, 
            audioCache: {}, 
            fetchQueue: [],
            settings: { speed: 1.0, pitch: 0, voice: "Joey", preferredProvider: "puter", systemVoiceName: localStorage.getItem("system_voice_name") || "" },
            currentAudio: null,
            view: 'reader',
            fallbackMode: false,
            systemVoices: [],
            synth: window.speechSynthesis || null,
            currentUtterance: null,
            visualizerInterval: null,
            puterUser: null,
            deferredPrompt: null
        };

        const els = {
            apiKey: document.getElementById('api-key-input'),
            mobileApiKey: document.getElementById('mobile-api-key'),
            mainText: document.getElementById('main-text'),
            readerDisplay: document.getElementById('reader-display'),
            urlInput: document.getElementById('url-input'),
            playBtn: document.getElementById('play-btn'),
            playIcon: document.getElementById('play-icon'),
            playLoader: document.getElementById('play-loader'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            speedSlider: document.getElementById('speed-slider'),
            speedVal: document.getElementById('speed-val'),
            miniSpeedVal: document.getElementById('mini-speed-val'),
            pitchSlider: document.getElementById('pitch-slider'),
            pitchVal: document.getElementById('pitch-val'),
            visualizer: document.getElementById('visualizer'),
            status: document.getElementById('status-text'),
            chunkInfo: document.getElementById('chunk-info'),
            toaster: document.getElementById('toaster'),
            toasterMsg: document.getElementById('toaster-msg'),
            scrapeBtn: document.getElementById('scrape-btn'),
            editToggleBtn: document.getElementById('edit-toggle-btn'),
            sidebar: document.getElementById('sidebar'),
            menuToggle: document.getElementById('menu-toggle'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            closeSidebar: document.getElementById('close-sidebar'),
            btnSummarize: document.getElementById('btn-summarize'),
            btnSimplify: document.getElementById('btn-simplify'),
            btnQuiz: document.getElementById('btn-quiz'),
            quizModal: document.getElementById('quiz-modal'),
            quizContent: document.getElementById('quiz-content'),
            closeQuiz: document.getElementById('close-quiz'),
            progressBar: document.getElementById('progress-bar'),
            viewReader: document.getElementById('view-reader'),
            viewVoices: document.getElementById('view-voices'),
            navReader: document.getElementById('nav-reader'),
            navVoices: document.getElementById('nav-voices'),
            voiceGrid: document.getElementById('voice-grid'),
            engineBadge: document.getElementById('engine-badge'),
            systemVoiceSelect: document.getElementById('system-voice-select'),
            engineGemini: document.getElementById('engine-gemini'),
            enginePuter: document.getElementById('engine-puter'),
            puterStatus: document.getElementById('puter-status'),
            envStatus: document.getElementById('env-status'), // New Element
            authControls: document.getElementById('auth-controls'),
            btnPuterLogin: document.getElementById('btn-puter-login'),
            installArea: document.getElementById('install-area'),
            btnInstall: document.getElementById('btn-install')
        };

        lucide.createIcons();

        // PWA Install
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); state.deferredPrompt = e;
            if (els.installArea) els.installArea.classList.remove('hidden');
        });
        if (els.btnInstall) els.btnInstall.onclick = () => {
            if(els.installArea) els.installArea.classList.add('hidden');
            if (state.deferredPrompt) { state.deferredPrompt.prompt(); state.deferredPrompt = null; }
        };

        // Puter Auth
        async function checkPuterAuth() {
            if (window.location.protocol === 'file:') {
                if (els.puterStatus) els.puterStatus.textContent = "FILE MODE";
                if (els.envStatus) { els.envStatus.textContent = "⚠️ Local File (Login Unavailable)"; els.envStatus.classList.add('text-red-400'); }
                if (els.authControls) els.authControls.innerHTML = `<div class="text-[10px] text-red-300 bg-red-900/20 p-2 rounded">Login unavailable in file mode.</div>`;
                return;
            }
            if (els.envStatus) { els.envStatus.textContent = "✅ Web Mode (Login Supported)"; els.envStatus.classList.add('text-green-400'); }
            
            if (typeof puter !== 'undefined' && puter.auth && puter.auth.isSignedIn()) {
                const user = await puter.auth.getUser();
                state.puterUser = user;
                updateAuthUI(true);
            } else updateAuthUI(false);
        }

        function updateAuthUI(isLoggedIn) {
            if (!els.puterStatus || !els.authControls) return;
            if (isLoggedIn) {
                els.puterStatus.textContent = "CONNECTED";
                els.puterStatus.classList.add("text-green-400");
                els.puterStatus.classList.remove("text-white/50");
                els.authControls.innerHTML = `
                    <div class="flex items-center gap-3 bg-white/5 p-2 rounded-lg mb-2">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-xs font-bold text-black">
                            ${state.puterUser.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="text-xs font-bold text-white truncate">${state.puterUser.username}</div>
                            <div class="text-[10px] text-green-400">Unlimited Quota</div>
                        </div>
                    </div>
                    <button onclick="logoutPuter()" class="w-full text-xs text-red-400 hover:text-red-300 py-3 transition">Logout</button>
                `;
            } else {
                els.puterStatus.textContent = "GUEST";
                els.puterStatus.classList.remove("text-green-400");
                els.puterStatus.classList.add("text-white/50");
                els.authControls.innerHTML = `<button onclick="loginPuter()" id="btn-login-action" class="w-full bg-white text-black py-3 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 active:scale-95 hover:bg-gray-200">Connect Puter Account</button>`;
            }
        }

        window.loginPuter = async () => {
            const btn = document.getElementById('btn-login-action'); if(btn) btn.innerText = "Connecting...";
            const timeout = new Promise((_, r) => setTimeout(() => r(new Error("Timeout")), 60000));
            try { await Promise.race([puter.auth.signIn(), timeout]); await checkPuterAuth(); toast("Logged in!", "success"); } 
            catch (e) { console.error(e); toast("Login Failed", "error"); updateAuthUI(false); }
        };
        window.logoutPuter = async () => { await puter.auth.signOut(); state.puterUser = null; updateAuthUI(false); toast("Logged out", "neutral"); };
        checkPuterAuth();

        // Audio & Voices
        function initAudio() {
            if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (state.audioCtx.state === 'suspended') state.audioCtx.resume();
        }

        for (let i = 0; i < 12; i++) {
            const bar = document.createElement('div'); bar.className = 'v-bar'; if (els.visualizer) els.visualizer.appendChild(bar);
        }

        function populateSystemVoices() {
            if (!state.synth) return;
            state.systemVoices = state.synth.getVoices();
            if (state.systemVoices.length === 0) setTimeout(() => { state.systemVoices = state.synth.getVoices(); renderSystemVoiceSelect(); }, 500);
            else renderSystemVoiceSelect();
        }
        function renderSystemVoiceSelect() {
            if (!els.systemVoiceSelect) return;
            els.systemVoiceSelect.innerHTML = '';
            if (state.systemVoices.length === 0) { els.systemVoiceSelect.innerHTML = '<option disabled>No system voices.</option>'; return; }
            const defaultVoice = state.systemVoices.find(v => v.name === state.settings.systemVoiceName) || state.systemVoices.find(v => v.lang.startsWith('en')) || state.systemVoices[0];
            state.settings.systemVoiceName = defaultVoice.name; localStorage.setItem("system_voice_name", state.settings.systemVoiceName);
            state.systemVoices.forEach(voice => {
                const option = document.createElement('option'); option.value = voice.name; option.textContent = `${voice.name} (${voice.lang})`;
                option.selected = voice.name === state.settings.systemVoiceName; els.systemVoiceSelect.appendChild(option);
            });
        }
        if (state.synth) { populateSystemVoices(); state.synth.onvoiceschanged = populateSystemVoices; }

        function renderVoiceGrid() {
            if (!els.voiceGrid) return;
            els.voiceGrid.innerHTML = '';
            VOICES.forEach(v => {
                const card = document.createElement('div');
                const isSelected = state.settings.voice === v.name;
                card.className = `glass-card p-4 rounded-xl cursor-pointer hover:bg-white/5 flex flex-col gap-2 ${isSelected ? 'active' : ''}`;
                let providerBadge = v.provider === 'gemini' 
                    ? `<span class="text-[10px] text-blue-400 bg-blue-400/10 px-1.5 rounded border border-blue-400/20">Gemini</span>`
                    : `<span class="text-[10px] text-green-400 bg-green-400/10 px-1.5 rounded border border-green-400/20">Puter</span>`;
                card.innerHTML = `
                    <div class="flex justify-between items-center"><span class="font-semibold text-sm ${isSelected ? 'text-white' : 'text-white/70'}">${v.label}</span>${providerBadge}</div>
                    <div class="flex justify-between items-end"><p class="text-xs text-white/50 w-3/4">${v.desc}</p><div class="px-2 py-0.5 rounded-full text-[10px] bg-white/10 border border-white/10 text-white/70">${v.tone}</div></div>
                `;
                card.onclick = () => selectVoice(v);
                els.voiceGrid.appendChild(card);
            });
        }
        renderVoiceGrid();

        function selectVoice(voiceObj) {
            state.settings.voice = voiceObj.name;
            state.settings.preferredProvider = voiceObj.provider;
            state.fallbackMode = false;
            toast(`Voice: ${voiceObj.name}`, "success");
            state.audioCache = {}; 
            renderVoiceGrid();
            updateBadge();
            if (state.isPlaying) { stopPlayback(); setTimeout(togglePlay, 200); }
        }

        function updateBadge() {
            if (!els.engineBadge) return;
            if (state.fallbackMode) { els.engineBadge.className = "engine-badge badge-system"; els.engineBadge.innerText = "SYSTEM"; }
            else if (state.settings.preferredProvider === 'gemini') { els.engineBadge.className = "engine-badge badge-gemini"; els.engineBadge.innerText = "GEMINI AI"; }
            else { els.engineBadge.className = "engine-badge badge-puter"; els.engineBadge.innerText = "PUTER AI"; }
        }

        function switchView(viewName) {
            state.view = viewName;
            if (viewName === 'reader') {
                if (els.viewReader) els.viewReader.classList.add('active'); if (els.viewVoices) els.viewVoices.classList.remove('active');
                if (els.navReader) { els.navReader.classList.add('bg-white', 'text-black'); els.navReader.classList.remove('bg-white/10', 'text-white'); }
                if (els.navVoices) { els.navVoices.classList.remove('bg-white', 'text-black'); els.navVoices.classList.add('bg-white/10', 'text-white'); }
            } else {
                if (els.viewReader) els.viewReader.classList.remove('active'); if (els.viewVoices) els.viewVoices.classList.add('active');
                if (els.navVoices) { els.navVoices.classList.add('bg-white', 'text-black'); els.navVoices.classList.remove('bg-white/10', 'text-white'); }
                if (els.navReader) { els.navReader.classList.remove('bg-white', 'text-black'); els.navReader.classList.add('bg-white/10', 'text-white'); }
            }
        }
        window.switchView = switchView;

        // --- Processing & Playback ---
        function processText() {
            if (!els.mainText) return;
            const raw = els.mainText.value.trim();
            if (!raw) return;
            state.textChunks = [];
            let htmlOutput = "";
            let chunkCounter = 0;
            const blocks = raw.split(/\n\n+/);
            blocks.forEach(block => {
                if (block.startsWith('#')) {
                    const text = block.replace(/^#+\s*/, ''); state.textChunks.push(text);
                    htmlOutput += `<h2 id="chunk-${chunkCounter}" class="chunk" onclick="skipTo(${chunkCounter})">${text}</h2>`; chunkCounter++;
                } else {
                    htmlOutput += '<p>';
                    const sentences = block.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g);
                    if (sentences) sentences.forEach(sent => { 
                        if(sent.trim()){ state.textChunks.push(sent.trim()); htmlOutput += `<span id="chunk-${chunkCounter}" class="chunk" onclick="skipTo(${chunkCounter})">${sent.trim()} </span>`; chunkCounter++; }
                    });
                    else { state.textChunks.push(block); htmlOutput += `<span id="chunk-${chunkCounter}" class="chunk" onclick="skipTo(${chunkCounter})">${block}</span>`; chunkCounter++; }
                    htmlOutput += '</p>';
                }
            });
            if (els.readerDisplay) els.readerDisplay.innerHTML = htmlOutput;
            state.currentChunkIndex = 0; state.audioCache = {};
            if(state.textChunks.length > 0) setReaderMode(true);
            updateUI();
        }

        async function fetchPuterTTS(text) {
            try { return await puter.ai.txt2speech(text, { engine: 'neural', voice: state.settings.voice }); } 
            catch (e) { if (typeof e === 'object' && (e.code === 'insufficient_funds' || e.error?.code === 'insufficient_funds')) throw new Error("PUTER_QUOTA_EXCEEDED"); throw e; }
        }

        async function fetchGeminiTTS(text) {
            if (!state.apiKey) throw new Error("No API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${state.apiKey}`;
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text }] }], generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: state.settings.voice } } } } }) });
            if (!res.ok) { if (res.status === 429) throw new Error("QUOTA_EXCEEDED"); throw new Error(await res.text()); }
            const data = await res.json();
            const binary = atob(data.candidates[0].content.parts[0].inlineData.data);
            const len = binary.length; const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
            // Simple Wav Header for 24k mono
            const wav = new Uint8Array(44 + len);
            const view = new DataView(wav.buffer);
            const writeString = (o, s) => { for (let i=0; i<s.length; i++) view.setUint8(o+i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + len, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, 24000, true);
            view.setUint32(28, 48000, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data'); view.setUint32(40, len, true);
            wav.set(bytes, 44);
            return new Audio(URL.createObjectURL(new Blob([wav], {type: 'audio/wav'})));
        }

        async function smartFetch(text) {
            if (state.fallbackMode) return null;
            if (state.settings.preferredProvider === 'puter') {
                try { return await fetchPuterTTS(text); } catch(e) { if(e.message==="PUTER_QUOTA_EXCEEDED") toast("Puter Quota Hit. Using System Voice.", "neutral"); state.fallbackMode = true; return null; }
            }
            try { return await fetchGeminiTTS(text); } catch(e) { 
                if(e.message.includes("QUOTA")) { toast("Gemini Quota Hit. Using Puter.", "neutral"); state.settings.preferredProvider='puter'; updateBadge(); try { return await fetchPuterTTS(text); } catch(err) { state.fallbackMode=true; return null; } }
                throw e; 
            }
        }

        async function playChunk(index) {
            if (index < 0 || index >= state.textChunks.length) { stopPlayback(); return; }
            const pid = state.playbackId;
            state.currentChunkIndex = index; updateUI();
            const el = document.getElementById(`chunk-${index}`); if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
            
            if (state.fallbackMode) { updateBadge(); playSystemTTS(state.textChunks[index], index); return; }

            if (!state.audioCache[index]) {
                setLoading(true);
                try {
                    const audio = await smartFetch(state.textChunks[index]);
                    if(state.playbackId !== pid) return;
                    if(!audio) { updateBadge(); playSystemTTS(state.textChunks[index], index); setLoading(false); return; }
                    state.audioCache[index] = audio;
                } catch(e) { if(state.playbackId === pid) { setLoading(false); toast("Error: "+e.message, "error"); } return; }
                setLoading(false);
            }

            if(state.playbackId !== pid || !state.isPlaying) return;
            if(state.currentAudio) { state.currentAudio.pause(); state.currentAudio.currentTime = 0; }
            const audio = state.audioCache[index];
            state.currentAudio = audio; audio.playbackRate = state.settings.speed;
            startVisualizer();
            try { await audio.play(); } catch(e){}
            audio.onended = () => { stopVisualizer(); if(state.isPlaying && state.playbackId === pid) playChunk(index+1); };
            preloadChunk(index+1);
        }

        function playSystemTTS(text, index) {
            if(!state.synth) return; state.synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = state.settings.speed;
            const v = state.systemVoices.find(v=>v.name===state.settings.systemVoiceName); if(v) u.voice=v;
            startVisualizer();
            u.onend = () => { stopVisualizer(); if(state.isPlaying) playChunk(index+1); };
            state.synth.speak(u);
        }

        async function preloadChunk(i) {
            if(i < state.textChunks.length && !state.audioCache[i] && !state.fallbackMode) {
                try { const a = await smartFetch(state.textChunks[i]); if(a) state.audioCache[i]=a; } catch(e){}
            }
        }

        // Utils
        function toast(msg, type='neutral') {
            if(!els.toasterMsg) return;
            els.toasterMsg.innerText = msg;
            els.toasterMsg.className = `glass px-6 py-3 rounded-full text-sm font-medium shadow-2xl flex items-center gap-2 bg-black/90 backdrop-blur-md border border-white/20 ${type==='error'?'text-red-400':type==='success'?'text-green-400':'text-white'}`;
            els.toaster.classList.add('show'); setTimeout(()=>els.toaster.classList.remove('show'), 3000);
        }
        function startVisualizer() { stopVisualizer(); state.visualizerInterval = setInterval(()=>document.querySelectorAll('.v-bar').forEach(b=>b.style.height=(Math.random()*24+4)+'px'), 80); }
        function stopVisualizer() { if(state.visualizerInterval) clearInterval(state.visualizerInterval); document.querySelectorAll('.v-bar').forEach(b=>b.style.height='4px'); }
        
        function updateUI() {
            if(els.playIcon) els.playIcon.setAttribute('data-lucide', state.isPlaying ? 'pause' : 'play'); lucide.createIcons();
            if(els.status) els.status.innerText = state.isPlaying ? 'PLAYING' : 'READY';
            if(els.chunkInfo) els.chunkInfo.innerText = `${state.currentChunkIndex+1} / ${state.textChunks.length}`;
            if(els.progressBar) els.progressBar.style.width = ((state.currentChunkIndex/state.textChunks.length)*100)+'%';
            updateBadge();
            document.querySelectorAll('.chunk').forEach(el => el.classList.remove('active'));
            const activeEl = document.getElementById(`chunk-${state.currentChunkIndex}`);
            if(activeEl) activeEl.classList.add('active');
        }

        function togglePlay() {
            if(state.textChunks.length===0) processText();
            if(state.textChunks.length===0) return toast("No text", "error");
            if(state.isPlaying) stopPlayback(); else { state.isPlaying=true; state.playbackId++; setReaderMode(true); playChunk(state.currentChunkIndex); updateUI(); }
        }
        function stopPlayback() {
            state.isPlaying=false; state.playbackId++;
            if(state.currentAudio) state.currentAudio.pause(); if(state.synth) state.synth.cancel();
            stopVisualizer(); updateUI(); setLoading(false);
        }
        function setLoading(b) { if(els.playIcon) { els.playIcon.classList.toggle('hidden', b); els.playLoader.classList.toggle('hidden', !b); } }
        function setReaderMode(b) {
            els.mainText.classList.toggle('hidden', b); els.readerDisplay.classList.toggle('hidden', !b);
            els.editToggleBtn.classList.toggle('hidden', !b); els.scrapeBtn.classList.toggle('hidden', b);
        }
        window.skipTo = (i) => { if(i!==state.currentChunkIndex) { state.playbackId++; state.isPlaying=false; if(state.currentAudio)state.currentAudio.pause(); if(state.synth)state.synth.cancel(); stopVisualizer(); setTimeout(()=>{state.isPlaying=true; playChunk(i);},50); } };

        // Listeners
        if(els.playBtn) els.playBtn.onclick = togglePlay;
        if(els.prevBtn) els.prevBtn.onclick = () => { if(state.currentChunkIndex>0) { stopPlayback(); state.isPlaying=true; playChunk(state.currentChunkIndex-1); } };
        if(els.nextBtn) els.nextBtn.onclick = () => { if(state.currentChunkIndex<state.textChunks.length-1) { stopPlayback(); state.isPlaying=true; playChunk(state.currentChunkIndex+1); } };
        if(els.speedSlider) els.speedSlider.oninput = (e) => {
            const v = parseFloat(e.target.value); state.settings.speed=v; 
            if(els.speedVal) els.speedVal.innerText=v.toFixed(1)+'x'; if(els.miniSpeedVal) els.miniSpeedVal.innerText=v.toFixed(1)+'x';
            if(state.currentAudio && !state.fallbackMode) state.currentAudio.playbackRate=v;
        };
        if(els.editToggleBtn) els.editToggleBtn.onclick = () => { setReaderMode(false); stopPlayback(); };
        if(els.scrapeBtn) els.scrapeBtn.onclick = async () => {
            if(!els.urlInput.value) return toast("Enter URL", "error");
            els.scrapeBtn.innerHTML = `<div class="loader w-4 h-4 border-white/30 border-l-white"></div>`;
            try {
                const res = await fetch(`https://r.jina.ai/${els.urlInput.value}`);
                if(!res.ok) throw new Error("Fetch failed");
                const text = await res.text();
                if(text.length<100) throw new Error("Blocked/Empty");
                els.mainText.value = text; processText(); toast("Imported", "success");
            } catch(e) { toast("Error: "+e.message, "error"); }
            finally { els.scrapeBtn.innerHTML = `<i data-lucide="download-cloud" class="w-4 h-4 text-white"></i>`; lucide.createIcons(); }
        };
        // Menus
        if(els.menuToggle) els.menuToggle.onclick = () => { if(els.sidebar) els.sidebar.classList.remove('translate-x-full'); if(els.sidebarOverlay) els.sidebarOverlay.classList.remove('hidden'); };
        const closeMenu = () => { if(els.sidebar) els.sidebar.classList.add('translate-x-full'); if(els.sidebarOverlay) els.sidebarOverlay.classList.add('hidden'); };
        if(els.closeSidebar) els.closeSidebar.onclick = closeMenu; if(els.sidebarOverlay) els.sidebarOverlay.onclick = closeMenu;
        
        // Sync API Key
        const syncKey = (e) => { state.apiKey = e.target.value; localStorage.setItem("gemini_key", state.apiKey); if(els.apiKey) els.apiKey.value=state.apiKey; if(els.mobileApiKey) els.mobileApiKey.value=state.apiKey; };
        if(els.apiKey) els.apiKey.oninput = syncKey; if(els.mobileApiKey) els.mobileApiKey.oninput = syncKey;
        if(els.apiKey) els.apiKey.value = state.apiKey; if(els.mobileApiKey) els.mobileApiKey.value = state.apiKey;

    </script>
</body>
</html>